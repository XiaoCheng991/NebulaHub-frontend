# IM 实时通讯系统增强需求

此文档用作记录并固定本次改造的需求范围与验收标准，后续实现将基于此 MD 文档逐步开发，避免对话历史过长导致需求遗忘。

## 1. 目标概览
- 基于现有的 Supabase Auth 系统，完善并落地以下六大能力：记忆身份、图片/文件上传、分离的单聊与群组、多端消息传输性能、@提及、以及头像设置，确保在用户体验、数据一致性、与后端安全方面均有明确约束与验收标准。
- 以文档驱动实现，后续变更通过更新此文档进行版本化与回溯。 

## 2. 核心需求与验收标准
### 1) 用户身份记忆功能（高优先级）
- 描述：进入 IM 界面时无需重复注册/输入即可继续上次的会话身份。进入页面时给出两种选择：继续使用“他之前的名字”进入，或选择“以新身份进入”。
- 依赖：Supabase Auth 已存在且可用于身份验证；前端需要维护一个本地的状态/持久化即可回显历史身份。
- 验收标准：
  - 首次进入后若检测到历史身份，展示“继续使用历史身份/新身份进入”选项。
  - 用户选择后将身份写入会话级状态并持久化（如 localStorage 或后端会话）以便下次进入仍可识别。
  - 未登录态隐藏身份记忆流程，进入时需走认证流程。

### 2) 图片和文件上传功能（高优先级）
- 描述：实现图片和文件的上传、预览和发送，使用 Supabase OSS 存储。
- 需求细节：
  - 支持图片（jpg/png/gif/webp 等）和常见文档/二进制文件上传。
  - 上传进度、错误处理、以及失败回退策略。
  - 上传成功后消息携带可访问的 URL，消息类型标识为 image/file。
- 验收标准：
  - 能在消息输入区域附带图片/文件，发送后能在聊天列表中正常展示缩略图或可下载链接。
  - OSS 存储与消息表的一致性，且异常时有明确错误提示。 

### 3) 单聊和群组功能（高优先级）
- 描述：从全体同窗的单一聊天窗口，切换为可选的“单聊”和“群组”模式，类似微信的联系人设计。
- 设计要点：
  - 联系人/群组概念、加入/离开群组、群组头像、群组成员显示、以及群组消息分离。
  - 支持按对话对象筛选并进入相应的聊天页。 
- 验收标准：
  - 可创建群组、发起/加入单聊会话、在不同对话之间切换且消息不会混乱。
  - 用户界面友好且在手机端可自适应。

### 4) 消息发送速度优化（中/高优先级）
- 描述：通过使用 Supabase Realtime、缓存、以及必要时引入中间件（如 Redis）提升消息发送、订阅与渲染速度。
- 关注点：
  - 实时订阅的吞吐、延迟、丢包容忍性。
  - 客户端缓存策略和消息幂等性处理。
- 验收标准：
  - 消息从发送到界面显示的时延显著降低，平均响应时间减少。 
  - 在网络波动条件下仍具有可观的鲁棒性。 

### 5) @ 提及功能（中/高优先级）
- 描述：在消息中对特定用户进行 @ 提及，触发对方提示与引用。
- 需求要点：
  - 支持自动补全用户列表（基于当前对话的成员）
  - 在消息数据中保存被提及用户的 id 集合，服务器端可用于通知和定位。
- 验收标准：
  - 在消息中正确插入被提及用户的标记，发送后对方能够看到高亮/通知。
  - 被提及的用户在对话列表中有相应提示。

### 6) 头像设置功能（中/高优先级）
- 描述：允许用户上传自定义头像，或选择默认头像。
- 需求要点：
  - 支持上传头像到 OSS，更新用户档案中的 avatar_url。
  - 提供默认头像选项，清晰回退处理。
- 验收标准：
  - 更新头像后在 UI 侧即时生效，消息气泡中的头像也应同步更新。

## 3. 数据模型简述（基于现有 Supabase 认证体系）
- 现状：auth.users 为认证用户表；需要通过 user_profiles 来扩展用户信息。
- 计划的核心表：
  - user_profiles: 用户显示名、头像、状态等
  - chat_rooms: 聊天室（direct/group）
  - room_members: 聊天室成员及角色
  - messages: 消息，支持 image/file，通过 message_type 标识
  - message_reads: 已读状态记录
  - user_relationships: 好友/关注关系

> 注：所有外键均以 UUID 为主，尽量避免 VARCHAR 与 UUID 的混用，以便提升性能和数据完整性。

## 4. 风险与前提
- 你需要确保 Supabase Auth 已正确配置，auth.uid() 与 当前数据库结构一致。
- 存储桶（avatars、chat-files）需在 Supabase 存储中存在并配置正确的权限策略。
- 变更涉及多张表的结构，需注意迁移顺序，避免在上线阶段产生数据不一致。 

## 5. 里程碑与交付
- 阶段 1：实现用户身份记忆与 Auth 驱动的进入流程
- 阶段 2：实现图片/文件上传（OSS）
- 阶段 3：实现单聊/群组与对话切换
- 阶段 4：实现消息发送优化与实时订阅
- 阶段 5：实现 @ 提及
- 阶段 6：实现头像设置

## 使用说明
- 未来所有实现均以此文档为单一来源，变更通过更新此 MD 文件完成版本控制。
- 开发时先对照此文档的验收标准，逐条实现并验证。
